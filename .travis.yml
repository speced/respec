language: node_js
dist: xenial
node_js:
  - lts/*
cache:
  directories:
    - node_modules # NPM packages

install:
  - npm install

addons:
  firefox: latest

karma_runner: &karma_runner
  - npm run build:w3c
  - npm run build:geonovum
  - travis_retry karma start --single-run --reporters mocha karma.conf.js

now_deploy: &now_deploy
  - npm run build:w3c
  - npm run build:geonovum
  - chmod +x ./tools/create-pr-meta.sh && ./tools/create-pr-meta.sh
  - npx now ./builds/ -A ../now.json --meta branch=$TRAVIS_BRANCH --token $NOW_TOKEN
  - npx now alias respec-$TRAVIS_BRANCH --token $NOW_TOKEN

jobs:
  include:
    - stage: Run eslint
      script:
        - npm run lint
    - stage: Deploy PR build
      if: NOT branch IN (master, develop)
      script: *now_deploy
    - stage: Run headless
      script:
        - npm run build:w3c
        - npm run test:headless
    - stage: Run Karma unit tests
      env:
        - BROWSERS=ChromeHeadless
      script: *karma_runner
    - env:
        - BROWSERS=FirefoxHeadlessPref
      script: *karma_runner
