{"version":3,"sources":["../node_modules/process/browser.js","builder.js"],"names":["async","colors","fsp","loading","path","presets","r","commandLineArgs","getUsage","setTheme","error","info","optionList","alias","defaultValue","description","name","type","Boolean","defaultOption","multiple","String","usageSections","header","content","desc","example","raw","appendBoilerplate","outPath","version","optimizedJs","sourceMap","respecJs","result","Error","mapPath","dirname","promiseToWriteJs","writeFile","code","promiseToWriteMap","Promise","all","Builder","getRespecVersion","packagePath","join","__dirname","readFile","JSON","parse","build","TypeError","buildPath","outFile","loadingMsg","timer","start","frames","clock","delay","task","buildVersion","outputWritter","config","baseUrl","deps","generateSourceMaps","inlineText","logLevel","mainConfigFile","optimize","preserveLicenseComments","useStrict","promiseToWrite","resolve","reject","out","concatinatedJS","then","catch","buildDir","workerDir","createReadStream","pipe","createWriteStream","stop","exports","require","main","module","run","parsedArgs","err","console","stack","process","exit","help","profile"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;6BCrLsB,iBACC,UACH,YACI,qBACH,QACG,6BACN,aACc,qBACP,kDARnBA,OACAC,QACAC,KACAC,SACAC,MACAC,SACAC,GACAC,iBACAC;AAXN;;AAEA;;AAUAP,SAAOQ,QAAP,CAAgB;AACdC,WAAO,KADO;AAEdC,UAAM;AAFQ,GAAhB;;AAKA,QAAMC,aAAa,CACjB;AACEC,WAAO,GADT;AAEEC,kBAAc,KAFhB;AAGEC,iBAAa,2BAHf;AAIEC,UAAM,MAJR;AAKEC,UAAMC;AALR,GADiB,EAQjB;AACEL,WAAO,GADT;AAEEM,mBAAe,IAFjB;AAGEJ,iBAAa,+CACX,4EAJJ;AAKEK,cAAU,KALZ;AAMEJ,UAAM,SANR;AAOEC,UAAMI;AAPR,GARiB,CAAnB;;AAmBA,QAAMC,gBAAgB,CACpB;AACEC,YAAQ,SADV;AAEEC,aAAS;AAFX,GADoB,EAKpB;AACED,YAAQ,SADV;AAEEX;AAFF,GALoB,EASpB;AACEW,YAAQ,UADV;AAEEC,aAAS,CACP;AACEC,YAAM,uBADR;AAEEC,eAAS;AAFX,KADO;AAFX,GAToB,EAkBpB;AACEF,aAAS,0DADX;AAEEG,SAAK;AAFP,GAlBoB,CAAtB;;AAwBA;;;;;;;;;AASA,WAASC,iBAAT,CAA2BC,OAA3B,EAAoCC,OAApC,EAA6Cd,IAA7C,EAAmD;AACjD,WAAOhB,MAAM,WAAU+B,WAAV,EAAuBC,SAAvB,EAAkC;AAC7C,YAAMC,WAAY;YACVH,OAAQ;;;;0BAIMA,OAAQ;EAChCC,WAAY;oBACMf,IAAK,MAPrB;AAQA,UAAI,WAAWkB,MAAf,EAAuB;AACrB,cAAM,IAAIC,KAAJ,CAAUD,OAAOxB,KAAjB,CAAN;AACD;AACD,YAAM0B,UAAUhC,KAAKiC,OAAL,CAAaR,OAAb,IAAyB,WAAUb,IAAK,eAAxD;AACA,YAAMsB,mBAAmBpC,IAAIqC,SAAJ,CAAcV,OAAd,EAAuBK,OAAOM,IAA9B,EAAoC,OAApC,CAAzB;AACA,YAAMC,oBAAoBvC,IAAIqC,SAAJ,CAAcH,OAAd,EAAuBJ,SAAvB,EAAkC,OAAlC,CAA1B;AACA,YAAMU,QAAQC,GAAR,CAAY,CAACL,gBAAD,EAAmBG,iBAAnB,CAAZ,CAAN;AACD,KAhBM,EAgBJG,OAhBI,CAAP;AAiBD;;AAED,QAAMA,UAAU;AACd;;;;;AAKAC,sBAAkB7C,MAAM,aAAY;AAClC,YAAM8C,cAAc1C,KAAK2C,IAAL,CAAUC,SAAV,EAAqB,iBAArB,CAApB;AACA,YAAMxB,UAAU,MAAMtB,IAAI+C,QAAJ,CAAaH,WAAb,EAA0B,OAA1B,CAAtB;AACA,aAAOI,KAAKC,KAAL,CAAW3B,OAAX,EAAoBM,OAA3B;AACD,KAJiB,CANJ;;AAYd;;;;;;;AAOAsB,UAAM,EAAEpC,IAAF,EAAN,EAAgB;AACd,UAAI,CAACA,IAAL,EAAW;AACT,cAAM,IAAIqC,SAAJ,CAAc,kBAAd,CAAN;AACD;AACD,YAAMC,YAAYlD,KAAK2C,IAAL,CAAUC,SAAV,EAAqB,WAArB,CAAlB;AACA,YAAMO,UAAW,UAASvC,IAAK,KAA/B;AACA,YAAMa,UAAUzB,KAAK2C,IAAL,CAAUO,SAAV,EAAqBC,OAArB,CAAhB;AACA,YAAMC,aAAavD,OAAOU,IAAP,CAAa,eAAc4C,OAAQ,mBAAnC,CAAnB;AACA,YAAME,QAAQtD,QAAQuD,KAAR,CAAcF,UAAd,EAA0B;AACtCG,gBAAQtD,QAAQuD,KADsB;AAEtCC,eAAO;AAF+B,OAA1B,CAAd;AAIA,aAAO7D,MAAM8D,IAAN,CAAW,aAAY;AAC5B;AACA,cAAMC,eAAe,MAAM,KAAKlB,gBAAL,EAA3B;AACA,cAAMmB,gBAAgBpC,kBAAkBC,OAAlB,EAA2BkC,YAA3B,EAAyC/C,IAAzC,CAAtB;AACA,cAAMiD,SAAS;AACbC,mBAAS9D,KAAK2C,IAAL,CAAUC,SAAV,EAAqB,QAArB,CADI;AAEbmB,gBAAM,CAAC,cAAD,CAFO;AAGbC,8BAAoB,IAHP;AAIbC,sBAAY,IAJC;AAKbC,oBAAU,CALG,EAKA;AACbC,0BAAiB,cAAavD,IAAK,KANtB;AAObA,gBAAO,WAAUA,IAAK,EAPT;AAQbwD,oBAAU,MARG;AASbC,mCAAyB,KATZ;AAUbC,qBAAW;AAVE,SAAf;AAYA,cAAMC,iBAAiB,IAAIjC,OAAJ,CAAY,CAACkC,OAAD,EAAUC,MAAV,KAAqB;AACtDZ,iBAAOa,GAAP,GAAa,CAACC,cAAD,EAAiB/C,SAAjB,KAA+B;AAC1CgC,0BAAce,cAAd,EAA8B/C,SAA9B,EAAyCgD,IAAzC,CAA8CJ,OAA9C,EAAuDK,KAAvD,CAA6DJ,MAA7D;AACD,WAFD;AAGD,SAJsB,CAAvB;AAKAvE,UAAEkE,QAAF,CAAWP,MAAX;AACA,cAAMiB,WAAW9E,KAAKwE,OAAL,CAAa5B,SAAb,EAAwB,YAAxB,CAAjB;AACA,cAAMmC,YAAY/E,KAAKwE,OAAL,CAAa5B,SAAb,EAAwB,YAAxB,CAAlB;AACA;AACA9C,YACGkF,gBADH,CACqB,GAAED,SAAU,mBADjC,EAEGE,IAFH,CAEQnF,IAAIoF,iBAAJ,CAAuB,GAAEJ,QAAS,mBAAlC,CAFR;AAGA,cAAMP,cAAN;AACAxE,gBAAQoF,IAAR,CAAa9B,KAAb;AACD,OA9BM,EA8BJ,IA9BI,CAAP;AA+BD;AA9Da,GAAhB;;AAiEA+B,UAAQ5C,OAAR,GAAkBA,OAAlB;AACA,MAAI6C,QAAQC,IAAR,KAAiBC,MAArB,EAA6B;AAC3B3F,UAAM8D,IAAN,CAAW,UAAU8B,GAAV,GAAgB;AACzB,UAAIC,UAAJ;AACA,UAAI;AACFA,qBAAatF,gBAAgBK,UAAhB,CAAb;AACD,OAFD,CAEE,OAAOkF,GAAP,EAAY;AACZC,gBAAQpF,IAAR,CAAaH,SAASc,aAAT,CAAb;AACAyE,gBAAQrF,KAAR,CAAcT,OAAOS,KAAP,CAAaoF,IAAIE,KAAjB,CAAd;AACA,eAAOC,QAAQC,IAAR,CAAa,GAAb,CAAP;AACD;AACD,UAAIL,WAAWM,IAAf,EAAqB;AACnBJ,gBAAQpF,IAAR,CAAaH,SAASc,aAAT,CAAb;AACA,eAAO2E,QAAQC,IAAR,CAAa,CAAb,CAAP;AACD;AACD,YAAM,EAAEE,SAASpF,IAAX,KAAoB6E,UAA1B;AACA,UAAI,CAAC7E,IAAL,EAAW;AACT;AACD;AACD,UAAI;AACF,cAAM4B,QAAQQ,KAAR,CAAc,EAAEpC,IAAF,EAAd,CAAN;AACD,OAFD,CAEE,OAAO8E,GAAP,EAAY;AACZC,gBAAQrF,KAAR,CAAcT,OAAOS,KAAP,CAAaoF,IAAIE,KAAjB,CAAd;AACA,eAAOC,QAAQC,IAAR,CAAa,CAAb,CAAP;AACD;AACDD,cAAQC,IAAR,CAAa,CAAb;AACD,KAxBD;AAyBD","file":"builder.map","sourcesContent":["// shim for using process in browser\nvar process = module.exports = {};\n\n// cached from whatever global is present so that test runners that stub it\n// don't break things.  But we need to wrap it in a try catch in case it is\n// wrapped in strict mode code which doesn't define any globals.  It's inside a\n// function because try/catches deoptimize in certain engines.\n\nvar cachedSetTimeout;\nvar cachedClearTimeout;\n\nfunction defaultSetTimout() {\n    throw new Error('setTimeout has not been defined');\n}\nfunction defaultClearTimeout () {\n    throw new Error('clearTimeout has not been defined');\n}\n(function () {\n    try {\n        if (typeof setTimeout === 'function') {\n            cachedSetTimeout = setTimeout;\n        } else {\n            cachedSetTimeout = defaultSetTimout;\n        }\n    } catch (e) {\n        cachedSetTimeout = defaultSetTimout;\n    }\n    try {\n        if (typeof clearTimeout === 'function') {\n            cachedClearTimeout = clearTimeout;\n        } else {\n            cachedClearTimeout = defaultClearTimeout;\n        }\n    } catch (e) {\n        cachedClearTimeout = defaultClearTimeout;\n    }\n} ())\nfunction runTimeout(fun) {\n    if (cachedSetTimeout === setTimeout) {\n        //normal enviroments in sane situations\n        return setTimeout(fun, 0);\n    }\n    // if setTimeout wasn't available but was latter defined\n    if ((cachedSetTimeout === defaultSetTimout || !cachedSetTimeout) && setTimeout) {\n        cachedSetTimeout = setTimeout;\n        return setTimeout(fun, 0);\n    }\n    try {\n        // when when somebody has screwed with setTimeout but no I.E. maddness\n        return cachedSetTimeout(fun, 0);\n    } catch(e){\n        try {\n            // When we are in I.E. but the script has been evaled so I.E. doesn't trust the global object when called normally\n            return cachedSetTimeout.call(null, fun, 0);\n        } catch(e){\n            // same as above but when it's a version of I.E. that must have the global object for 'this', hopfully our context correct otherwise it will throw a global error\n            return cachedSetTimeout.call(this, fun, 0);\n        }\n    }\n\n\n}\nfunction runClearTimeout(marker) {\n    if (cachedClearTimeout === clearTimeout) {\n        //normal enviroments in sane situations\n        return clearTimeout(marker);\n    }\n    // if clearTimeout wasn't available but was latter defined\n    if ((cachedClearTimeout === defaultClearTimeout || !cachedClearTimeout) && clearTimeout) {\n        cachedClearTimeout = clearTimeout;\n        return clearTimeout(marker);\n    }\n    try {\n        // when when somebody has screwed with setTimeout but no I.E. maddness\n        return cachedClearTimeout(marker);\n    } catch (e){\n        try {\n            // When we are in I.E. but the script has been evaled so I.E. doesn't  trust the global object when called normally\n            return cachedClearTimeout.call(null, marker);\n        } catch (e){\n            // same as above but when it's a version of I.E. that must have the global object for 'this', hopfully our context correct otherwise it will throw a global error.\n            // Some versions of I.E. have different rules for clearTimeout vs setTimeout\n            return cachedClearTimeout.call(this, marker);\n        }\n    }\n\n\n\n}\nvar queue = [];\nvar draining = false;\nvar currentQueue;\nvar queueIndex = -1;\n\nfunction cleanUpNextTick() {\n    if (!draining || !currentQueue) {\n        return;\n    }\n    draining = false;\n    if (currentQueue.length) {\n        queue = currentQueue.concat(queue);\n    } else {\n        queueIndex = -1;\n    }\n    if (queue.length) {\n        drainQueue();\n    }\n}\n\nfunction drainQueue() {\n    if (draining) {\n        return;\n    }\n    var timeout = runTimeout(cleanUpNextTick);\n    draining = true;\n\n    var len = queue.length;\n    while(len) {\n        currentQueue = queue;\n        queue = [];\n        while (++queueIndex < len) {\n            if (currentQueue) {\n                currentQueue[queueIndex].run();\n            }\n        }\n        queueIndex = -1;\n        len = queue.length;\n    }\n    currentQueue = null;\n    draining = false;\n    runClearTimeout(timeout);\n}\n\nprocess.nextTick = function (fun) {\n    var args = new Array(arguments.length - 1);\n    if (arguments.length > 1) {\n        for (var i = 1; i < arguments.length; i++) {\n            args[i - 1] = arguments[i];\n        }\n    }\n    queue.push(new Item(fun, args));\n    if (queue.length === 1 && !draining) {\n        runTimeout(drainQueue);\n    }\n};\n\n// v8 likes predictible objects\nfunction Item(fun, array) {\n    this.fun = fun;\n    this.array = array;\n}\nItem.prototype.run = function () {\n    this.fun.apply(null, this.array);\n};\nprocess.title = 'browser';\nprocess.browser = true;\nprocess.env = {};\nprocess.argv = [];\nprocess.version = ''; // empty string to avoid regexp issues\nprocess.versions = {};\n\nfunction noop() {}\n\nprocess.on = noop;\nprocess.addListener = noop;\nprocess.once = noop;\nprocess.off = noop;\nprocess.removeListener = noop;\nprocess.removeAllListeners = noop;\nprocess.emit = noop;\nprocess.prependListener = noop;\nprocess.prependOnceListener = noop;\n\nprocess.listeners = function (name) { return [] }\n\nprocess.binding = function (name) {\n    throw new Error('process.binding is not supported');\n};\n\nprocess.cwd = function () { return '/' };\nprocess.chdir = function (dir) {\n    throw new Error('process.chdir is not supported');\n};\nprocess.umask = function() { return 0; };\n","#!/usr/bin/env node\n\n\"use strict\";\nconst async = require(\"marcosc-async\");\nconst colors = require(\"colors\");\nconst fsp = require(\"fs-extra\");\nconst loading = require(\"loading-indicator\");\nconst path = require(\"path\");\nconst presets = require(\"loading-indicator/presets\");\nconst r = require(\"requirejs\");\nconst commandLineArgs = require(\"command-line-args\");\nconst getUsage = require(\"command-line-usage\");\ncolors.setTheme({\n  error: \"red\",\n  info: \"green\",\n});\n\nconst optionList = [\n  {\n    alias: \"h\",\n    defaultValue: false,\n    description: \"Display this usage guide.\",\n    name: \"help\",\n    type: Boolean,\n  },\n  {\n    alias: \"p\",\n    defaultOption: true,\n    description: \"Name of profile to build. Profile must be \" +\n      \"in the js/ folder, and start with 'profile-' (e.g., profile-w3c-common.js)\",\n    multiple: false,\n    name: \"profile\",\n    type: String,\n  },\n];\n\nconst usageSections = [\n  {\n    header: \"builder\",\n    content: \"Builder builds a ReSpec profile\",\n  },\n  {\n    header: \"Options\",\n    optionList,\n  },\n  {\n    header: \"Examples\",\n    content: [\n      {\n        desc: \"1. Build W3C Profile \",\n        example: \"$ ./tools/builder.js --profile=w3c-common\",\n      },\n    ],\n  },\n  {\n    content: \"Project home: [underline]{https://github.com/w3c/respec}\",\n    raw: true,\n  },\n];\n\n/**\n * Async function that appends the boilerplate to the generated script\n * and writes out the result. It also creates the source map file.\n *\n * @private\n * @param  {String} outPath Where to write the output to.\n * @param  {String} version The version of the script.\n * @return {Promise} Resolves when done writing the files.\n */\nfunction appendBoilerplate(outPath, version, name) {\n  return async(function*(optimizedJs, sourceMap) {\n    const respecJs = `\"use strict\";\n/* ReSpec ${version}\nCreated by Robin Berjon, http://berjon.com/ (@robinberjon)\nDocumentation: http://w3.org/respec/.\nSee original source for licenses: https://github.com/w3c/respec */\nwindow.respecVersion = \"${version}\";\n${optimizedJs}\nrequire(['profile-${name}']);`;\n    if (\"error\" in result) {\n      throw new Error(result.error);\n    }\n    const mapPath = path.dirname(outPath) + `/respec-${name}.build.js.map`;\n    const promiseToWriteJs = fsp.writeFile(outPath, result.code, \"utf-8\");\n    const promiseToWriteMap = fsp.writeFile(mapPath, sourceMap, \"utf-8\");\n    yield Promise.all([promiseToWriteJs, promiseToWriteMap]);\n  }, Builder);\n}\n\nconst Builder = {\n  /**\n   * Async function that gets the current version of ReSpec from package.json\n   *\n   * @returns {Promise<String>} The version string.\n   */\n  getRespecVersion: async(function*() {\n    const packagePath = path.join(__dirname, \"../package.json\");\n    const content = yield fsp.readFile(packagePath, \"utf-8\");\n    return JSON.parse(content).version;\n  }),\n\n  /**\n   * Async function runs Requirejs' optimizer to generate the output.\n   *\n   * using a custom configuration.\n   * @param  {[type]} options [description]\n   * @return {[type]}         [description]\n   */\n  build({ name }) {\n    if (!name) {\n      throw new TypeError(\"name is required\");\n    }\n    const buildPath = path.join(__dirname, \"../builds\");\n    const outFile = `respec-${name}.js`;\n    const outPath = path.join(buildPath, outFile);\n    const loadingMsg = colors.info(` Generating ${outFile}. Please wait... `);\n    const timer = loading.start(loadingMsg, {\n      frames: presets.clock,\n      delay: 1,\n    });\n    return async.task(function*() {\n      // optimisation settings\n      const buildVersion = yield this.getRespecVersion();\n      const outputWritter = appendBoilerplate(outPath, buildVersion, name);\n      const config = {\n        baseUrl: path.join(__dirname, \"../js/\"),\n        deps: [\"deps/require\"],\n        generateSourceMaps: true,\n        inlineText: true,\n        logLevel: 2, // Show uglify warnings and errors.\n        mainConfigFile: `js/profile-${name}.js`,\n        name: `profile-${name}`,\n        optimize: \"none\",\n        preserveLicenseComments: false,\n        useStrict: true,\n      };\n      const promiseToWrite = new Promise((resolve, reject) => {\n        config.out = (concatinatedJS, sourceMap) => {\n          outputWritter(concatinatedJS, sourceMap).then(resolve).catch(reject);\n        };\n      });\n      r.optimize(config);\n      const buildDir = path.resolve(__dirname, \"../builds/\");\n      const workerDir = path.resolve(__dirname, \"../worker/\");\n      // copy respec-worker\n      fsp\n        .createReadStream(`${workerDir}/respec-worker.js`)\n        .pipe(fsp.createWriteStream(`${buildDir}/respec-worker.js`));\n      yield promiseToWrite;\n      loading.stop(timer);\n    }, this);\n  },\n};\n\nexports.Builder = Builder;\nif (require.main === module) {\n  async.task(function* run() {\n    let parsedArgs;\n    try {\n      parsedArgs = commandLineArgs(optionList);\n    } catch (err) {\n      console.info(getUsage(usageSections));\n      console.error(colors.error(err.stack));\n      return process.exit(127);\n    }\n    if (parsedArgs.help) {\n      console.info(getUsage(usageSections));\n      return process.exit(0);\n    }\n    const { profile: name } = parsedArgs;\n    if (!name) {\n      return;\n    }\n    try {\n      yield Builder.build({ name });\n    } catch (err) {\n      console.error(colors.error(err.stack));\n      return process.exit(1);\n    }\n    process.exit(0);\n  });\n}\n"]}